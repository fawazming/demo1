<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bulk SMS JSON Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full flex items-center justify-center p-6">
  <div class="max-w-4xl w-full bg-white rounded-lg shadow p-6 space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">Bulk SMS JSON Generator</h1>

    <div>
      <label for="unstructured" class="block font-semibold mb-1">CSV Data (one entry per line)</label>
      <textarea id="unstructured" rows="8" placeholder="e.g.
John Doe,08108097322,Class A
Jane Smith,07061811568,Class B
Alice Johnson,09012345678,Class C,Grade 10
" class="w-full rounded border border-gray-300 p-3 resize-y focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      <p class="mt-1 text-sm text-gray-500">CSV format: name,phone,class,grade (include headers or provide consistent columns)</p>
      
      <div class="mt-2 flex gap-2">
        <button id="parseBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Parse CSV</button>
        <button id="aiParseBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition" onclick="sendToAI()">Send to AI for Structuring</button>
      </div>
    </div>

    <div id="aiPromptSection" class="hidden bg-yellow-50 border border-yellow-200 rounded p-4">
      <h3 class="font-semibold text-yellow-800 mb-2">AI Prompt Generated</h3>
      <textarea id="aiPrompt" rows="4" class="w-full rounded border border-yellow-300 p-3 text-sm bg-white resize-y font-mono"></textarea>
      <p class="mt-2 text-sm text-yellow-700">Copy this prompt and send to your AI assistant. Paste the structured JSON response below.</p>
      
      <div class="mt-3 flex gap-2">
        <button onclick="copyAIPrompt()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">Copy Prompt</button>
        <button onclick="pasteAIResponse()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Paste AI Response</button>
      </div>
    </div>

    <div id="structuredSection" class="hidden">
      <label for="structured" class="block font-semibold mb-1">Structured Data (Parsed JSON)</label>
      <textarea id="structured" rows="6" class="w-full rounded border border-gray-300 p-3 font-mono text-sm bg-gray-100 resize-y"></textarea>
      <p class="mt-1 text-sm text-gray-500">Structured data extracted from CSV. Review and edit if needed.</p>
    </div>

    <div>
      <label for="message" class="block font-semibold mb-1">Message Template</label>
      <textarea id="message" rows="4" placeholder="e.g. Hello {name}, your class is {class}." class="w-full rounded border border-gray-300 p-3 resize-y focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      <p class="mt-1 text-sm text-gray-500">Use placeholders like <code>{name}</code>, <code>{class}</code> to be replaced from structured data.</p>
    </div>

    <div class="flex gap-2">
      <button id="generateBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">Generate SMS JSON</button>
      <button onclick="copyOutput()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">Copy Output</button>
    </div>

    <div>
      <label for="output" class="block font-semibold mb-1">Output JSON (Bulk SMS Format)</label>
      <textarea id="output" rows="10" class="w-full rounded border border-gray-300 p-3 font-mono text-sm bg-gray-100 resize-y"></textarea>
    </div>
    <div class="flex gap-2">
      <input type="text" id="slug" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
      <button id="generateSlugBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">Send JSON to API</button>
      <p id="slugOut"></p>
    </div>
  </div>

  <script>
    // Store parsed data globally
    let parsedData = [];

    // Parse CSV data
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length === 0) return [];

      // Check if first line might be headers
      const firstLine = lines[0].toLowerCase();
      const hasHeaders = firstLine.includes('name') || firstLine.includes('phone') || firstLine.includes('class');

      const results = [];
      const startIndex = hasHeaders ? 1 : 0;

      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const columns = line.split(',').map(col => col.trim());
        
        // Try to extract phone number (look for column with digits)
        let phone = null;
        let name = 'Unknown';
        let className = 'N/A';
        let grade = 'N/A';
        let otherData = {};

        columns.forEach((col, index) => {
          // Check if this column contains a phone number
          const digits = col.replace(/[^\d]/g, '');
          if (digits.length >= 7 && digits.length <= 15 && !phone) {
            phone = digits;
            return;
          }

          // Check for name (contains letters and spaces)
          if (/[a-zA-Z]/.test(col) && col.includes(' ') && name === 'Unknown') {
            name = col;
            return;
          }

          // Check for class/grade patterns
          if (/class|grade|level/i.test(col)) {
            if (/class/i.test(col)) className = col;
            if (/grade/i.test(col)) grade = col;
            return;
          }

          // Store other data
          if (col && index > 0) {
            otherData[`col${index}`] = col;
          }
        });

        if (phone) {
          results.push({
            phone,
            name,
            class: className,
            grade,
            ...otherData,
            original: line
          });
        }
      }

      return results;
    }

    // Parse CSV data and update structured output
    function parseCSVData() {
      const csvText = document.getElementById('unstructured').value;
      const structuredEl = document.getElementById('structured');
      const structuredSection = document.getElementById('structuredSection');
      
      if (!csvText.trim()) {
        structuredEl.value = '// No CSV data to parse';
        structuredSection.classList.remove('hidden');
        return [];
      }

      const parsed = parseCSV(csvText);

      // Update structured data textarea
      structuredEl.value = JSON.stringify(parsed, null, 2);
      structuredSection.classList.remove('hidden');
      
      return parsed;
    }

    // Generate AI prompt for structuring data
    function sendToAI() {
      const csvText = document.getElementById('unstructured').value;
      if (!csvText.trim()) {
        alert('Please enter some CSV data first');
        return;
      }

      const aiPrompt = `Please structure this CSV data into a clean JSON array. 

        CSV Data:
        ${csvText}

        Please return a JSON array where each object has it header. A phone header must be included whose data is a phone number

        Return ONLY the JSON array, no additional text or explanations.`;

      document.getElementById('aiPrompt').value = aiPrompt;
      document.getElementById('aiPromptSection').classList.remove('hidden');
    }

    // Copy AI prompt to clipboard
    function copyAIPrompt() {
      const promptText = document.getElementById('aiPrompt');
      promptText.select();
      document.execCommand('copy');
      alert('AI prompt copied to clipboard!');
    }

    // Paste AI response into structured data
    function pasteAIResponse() {
      const response = prompt('Paste the AI response (JSON array):');
      if (response) {
        try {
          const parsedResponse = JSON.parse(response);
          if (Array.isArray(parsedResponse)) {
            document.getElementById('structured').value = JSON.stringify(parsedResponse, null, 2);
            parsedData = parsedResponse;
            document.getElementById('structuredSection').classList.remove('hidden');
            alert('AI response imported successfully!');
          } else {
            alert('Response must be a JSON array');
          }
        } catch (e) {
          alert('Invalid JSON response: ' + e.message);
        }
      }
    }

    // Replace placeholders in message template with data object values
    function fillTemplate(template, data) {
      return template.replace(/\{(\w+)\}/g, (_, key) => {
        return data[key] ?? `{${key}}`;
      });
    }

    // Copy output to clipboard
    function copyOutput() {
      const outputText = document.getElementById('output');
      outputText.select();
      document.execCommand('copy');
      alert('Output copied to clipboard!');
    }

    async function postData(slug, data) {
      const url = `https://jserve.sgm.ng/data/${slug}`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Success:', result);
        return result;
      } catch (error) {
        console.error('Error:', error);
      }
    }


    // Parse button handler
    document.getElementById('parseBtn').addEventListener('click', () => {
      parsedData = parseCSVData();
    });

    document.getElementById('generateSlugBtn').addEventListener('click', () => {
        const data = document.getElementById('output').value;
        const slug = document.getElementById('slug').value;
        postData(slug, data);
    });

    // Auto-parse when CSV data changes
    document.getElementById('unstructured').addEventListener('input', () => {
      if (!document.getElementById('unstructured').value.trim()) {
        document.getElementById('structured').value = '';
        document.getElementById('structuredSection').classList.add('hidden');
        parsedData = [];
      }
    });

    // Generate button handler
    document.getElementById('generateBtn').addEventListener('click', () => {
      const messageTemplate = document.getElementById('message').value.trim();
      const outputEl = document.getElementById('output');

      // If parsedData is empty, try to parse first
      if (parsedData.length === 0) {
        parsedData = parseCSVData();
      }

      if (parsedData.length === 0) {
        outputEl.value = '// Please enter and parse valid CSV data first.';
        return;
      }

      if (!messageTemplate) {
        outputEl.value = '// Please enter a message template.';
        return;
      }

      const msgArray = parsedData.map(data => {
        return {
          phone: data.phone,
          message: fillTemplate(messageTemplate, data)
        };
      });

      const result = { msg: msgArray };
      outputEl.value = JSON.stringify(result, null, 2);
    });

    // Allow manual editing of structured data with validation
    document.getElementById('structured').addEventListener('input', function() {
      try {
        const editedData = JSON.parse(this.value);
        if (Array.isArray(editedData)) {
          parsedData = editedData;
        }
      } catch (e) {
        // Invalid JSON, keep previous parsed data
      }
    });
  </script>
</body>
</html>

